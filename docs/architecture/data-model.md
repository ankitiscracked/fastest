# Data model

This document describes the core primitives in Fastest. The canonical sources are the D1 schema (`api/src/db/schema.sql`), the shared TypeScript types (`packages/shared/src/index.ts`), and the Go config/manifest packages.

## Project

A project groups workspaces and snapshots under a single owner.

| Field | Type | Notes |
|-------|------|-------|
| `id` | string (ULID) | Primary key |
| `owner_user_id` | string | References `users.id` |
| `name` | string | Display name |
| `intent` | string/null | Project intent: startup, personal_tool, learning, etc. |
| `brief` | JSON/null | Structured brief (StartupBrief or PersonalToolBrief) |
| `last_snapshot_id` | string/null | Most recent snapshot across all workspaces |
| `main_workspace_id` | string/null | Default comparison target for drift |
| `created_at` | datetime | |
| `updated_at` | datetime | |

Defined in: `api/src/db/schema.sql` (table `projects`), `packages/shared/src/index.ts` (interface `Project`).

The `main_workspace_id` is stored server-side only and is used by `fst drift` when no target workspace is specified.

## Workspace

A workspace is a local directory with a `.fst/` metadata directory, linked to a project. Multiple workspaces can exist for the same project (parallel development).

**Cloud schema** (`api/src/db/schema.sql`, table `workspaces`):

| Field | Type | Notes |
|-------|------|-------|
| `id` | string (ULID) | Primary key |
| `project_id` | string | References `projects.id` |
| `name` | string | Workspace name |
| `machine_id` | string/null | Hostname of the machine |
| `base_snapshot_id` | string/null | Fork point snapshot |
| `current_snapshot_id` | string/null | Latest snapshot |
| `current_manifest_hash` | string/null | Hash of latest manifest |
| `local_path` | string/null | Filesystem path on the machine |
| `version` | integer | Optimistic locking counter |
| `last_seen_at` | datetime/null | |
| `created_at` | datetime | |

**Local config** (`cli/internal/config/config.go`, struct `ProjectConfig`, stored in `.fst/config.json`):

| Field | JSON key | Notes |
|-------|----------|-------|
| `ProjectID` | `project_id` | Links to cloud project |
| `WorkspaceID` | `workspace_id` | Links to cloud workspace |
| `WorkspaceName` | `workspace_name` | Display name |
| `BaseSnapshotID` | `base_snapshot_id` | Fork point |
| `CurrentSnapshotID` | `current_snapshot_id` | Latest local snapshot |
| `APIURL` | `api_url` | Optional API URL override |
| `Mode` | `mode` | `"cloud"` or `"local"` |

**Global registry** (`cli/internal/index/index.go`): All workspaces on the local machine are tracked in `~/.config/fst/index.json` so commands like `fst workspaces` and `fst merge <name>` can resolve workspace names to filesystem paths.

## Snapshot

An immutable point-in-time capture of all tracked files in a workspace. Snapshots form a DAG via `parent_snapshot_ids`.

**Cloud schema** (`api/src/db/schema.sql`, table `snapshots`):

| Field | Type | Notes |
|-------|------|-------|
| `id` | string (ULID) | Primary key, generated by `generateSnapshotID()` |
| `project_id` | string | References `projects.id` |
| `manifest_hash` | string | SHA-256 of the serialized manifest JSON |
| `parent_snapshot_ids` | JSON array | DAG edges (0 = root, 1 = normal, 2 = merge) |
| `source` | string | `cli`, `web`, `import`, `system` |
| `created_at` | datetime | |

**Local metadata** (stored as `.fst/snapshots/{id}.meta.json`):

```json
{
  "id": "snap-...",
  "workspace_id": "...",
  "workspace_name": "...",
  "manifest_hash": "abc123...",
  "parent_snapshot_ids": ["snap-parent"],
  "message": "description of changes",
  "agent": "claude",
  "created_at": "2025-01-15T10:00:00Z",
  "files": 42,
  "size": 123456
}
```

The DAG is traversed by `cli/internal/dag/mergebase.go` using BFS to find the common ancestor (merge base) of two snapshot heads.

## Manifest

A manifest is a sorted list of file entries representing the complete state of a workspace at a point in time.

Defined in `cli/internal/manifest/manifest.go` (Go) and `packages/shared/src/manifest/` (TypeScript).

```json
{
  "version": "1",
  "files": [
    { "type": "file", "path": "src/main.go", "hash": "sha256-hex", "size": 1234, "mode": 420 },
    { "type": "dir", "path": "src/utils", "mode": 493 },
    { "type": "symlink", "path": "link", "target": "../other" }
  ]
}
```

The manifest hash is the SHA-256 of its canonical JSON serialization (indented with two spaces). This hash is used as the filename in `.fst/manifests/{hash}.json` and as the R2 key for cloud storage.

## FileEntry

Each entry in the manifest `files` array. Three types are supported:

| Field | Type | Notes |
|-------|------|-------|
| `type` | string | `"file"`, `"dir"`, or `"symlink"` |
| `path` | string | Forward-slash relative path from workspace root |
| `hash` | string | SHA-256 of file content (files only) |
| `size` | int64 | Byte size (files only) |
| `mode` | uint32 | Unix permission bits |
| `mod_time` | int64 | Unix timestamp, optional (excluded for reproducibility by default) |
| `target` | string | Symlink target path (symlinks only) |

Files are sorted by path for reproducibility. The `Diff()` function in `manifest.go` compares two manifests to produce added/modified/deleted file lists. Equality for files is determined by hash and mode; for symlinks by target; for directories by mode.

## Relationships

```
User 1--* Project
Project 1--* Workspace
Project 1--* Snapshot
Workspace *--1 Snapshot (base_snapshot_id)
Workspace *--1 Snapshot (current_snapshot_id)
Snapshot *--* Snapshot (parent_snapshot_ids, DAG)
Snapshot 1--1 Manifest (via manifest_hash)
Manifest 1--* FileEntry
FileEntry *--1 Blob (via hash, content-addressed)
```
